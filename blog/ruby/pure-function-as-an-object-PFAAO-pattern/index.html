<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>The Pure Function As An Object (PFAAO) Ruby Pattern — Tom Dalling</title>
    <link href="/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro" />
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <link rel="canonical" href="/blog/ruby/pure-function-as-an-object-PFAAO-pattern/" /></head>

  <body>

    <div class="container">

      <div class="row">
        <div class="col-md-12">
          <nav role="navigation" class="navbar navbar-default">
            <div class="container-fluid">
              <div class="navbar-header">
                <button data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" class="navbar-toggle" type="button">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a href="/" class="navbar-brand">Tom Dalling</a>
              </div>

              <div id="bs-example-navbar-collapse-1" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                  <li><a href="/">Home</a></li>
                  <li><a href="/blog/">Blog</a></li>
                </ul>
              </div>
            </div>
          </nav>
        </div>
      </div>

      <div class="row">

        <main class="col-md-8"><article class="post post-single">

  <header>
    <h1><a href="/blog/ruby/pure-function-as-an-object-PFAAO-pattern/">The Pure Function As An Object (PFAAO) Ruby Pattern</a></h1>
    <small class="meta">
      <span class="post-date">12 Feb, 2016</span>
      —
      Category: <a href="/blog/category/ruby/" class="category">Ruby</a>
    </small>
    <div class="main-image">
      <img class="img-responsive" src="/images/posts/ruby.jpg" />
      <span class="credit">Image courtesy of <a href="http://www.irocks.com/" class="artist">Rob Lavinsky, iRocks.com</a>.</span>
    </div>
  </header>

  <div class="post-content"><p>In this article, I want to demonstrate a nice way to write functional-style code in Ruby. It is a way to write non-trivial pure functions, without a bunch of weird non-idiomatic code. Also, the acronym is PFAAO, which I think sounds pretty cool.</p>
<!--more--><h2>Pure Functions</h2><p>Pure functions are functions that have no side-effects, and whose return values are only determined by their arguments. Given the same arguments, a pure function will always return the same value. It does nothing other than generate a return value – it doesn't affect anything, anywhere else in the program.</p><p>Pure functions are the core concept of functional programming (FP). I'm going to gloss over the benefits of FP, because there are plenty of other articles about that. Let's just say that pure functions are good, and you should be writing them wherever possible.</p><h2>The Example: A JSON To XML Converter</h2><p>To demonstrate this pattern, I'm going to write a program that converts a JSON document to XML. The whole example project is available on GitHub, here: <a href="https://github.com/tomdalling/pure-function-as-an-object">https://github.com/tomdalling/pure-function-as-an-object</a></p><p>The input looks like this:</p>
<div class="highlight"><pre><span class="p">{</span> <span class="nt">"city"</span> <span class="p">:</span> <span class="s2">"AGAWAM"</span><span class="p">,</span> <span class="nt">"loc"</span> <span class="p">:</span> <span class="p">[</span> <span class="mf">-72.622739</span><span class="p">,</span> <span class="mf">42.070206</span> <span class="p">],</span> <span class="nt">"pop"</span> <span class="p">:</span> <span class="mi">15338</span><span class="p">,</span> <span class="nt">"state"</span> <span class="p">:</span> <span class="s2">"MA"</span><span class="p">,</span> <span class="nt">"_id"</span> <span class="p">:</span> <span class="s2">"01001"</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">"city"</span> <span class="p">:</span> <span class="s2">"CUSHMAN"</span><span class="p">,</span> <span class="nt">"loc"</span> <span class="p">:</span> <span class="p">[</span> <span class="mf">-72.51564999999999</span><span class="p">,</span> <span class="mf">42.377017</span> <span class="p">],</span> <span class="nt">"pop"</span> <span class="p">:</span> <span class="mi">36963</span><span class="p">,</span> <span class="nt">"state"</span> <span class="p">:</span> <span class="s2">"MA"</span><span class="p">,</span> <span class="nt">"_id"</span> <span class="p">:</span> <span class="s2">"01002"</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">"city"</span> <span class="p">:</span> <span class="s2">"BARRE"</span><span class="p">,</span> <span class="nt">"loc"</span> <span class="p">:</span> <span class="p">[</span> <span class="mf">-72.10835400000001</span><span class="p">,</span> <span class="mf">42.409698</span> <span class="p">],</span> <span class="nt">"pop"</span> <span class="p">:</span> <span class="mi">4546</span><span class="p">,</span> <span class="nt">"state"</span> <span class="p">:</span> <span class="s2">"MA"</span><span class="p">,</span> <span class="nt">"_id"</span> <span class="p">:</span> <span class="s2">"01005"</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">"city"</span> <span class="p">:</span> <span class="s2">"BELCHERTOWN"</span><span class="p">,</span> <span class="nt">"loc"</span> <span class="p">:</span> <span class="p">[</span> <span class="mf">-72.41095300000001</span><span class="p">,</span> <span class="mf">42.275103</span> <span class="p">],</span> <span class="nt">"pop"</span> <span class="p">:</span> <span class="mi">10579</span><span class="p">,</span> <span class="nt">"state"</span> <span class="p">:</span> <span class="s2">"MA"</span><span class="p">,</span> <span class="nt">"_id"</span> <span class="p">:</span> <span class="s2">"01007"</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">"city"</span> <span class="p">:</span> <span class="s2">"BLANDFORD"</span><span class="p">,</span> <span class="nt">"loc"</span> <span class="p">:</span> <span class="p">[</span> <span class="mf">-72.936114</span><span class="p">,</span> <span class="mf">42.182949</span> <span class="p">],</span> <span class="nt">"pop"</span> <span class="p">:</span> <span class="mi">1240</span><span class="p">,</span> <span class="nt">"state"</span> <span class="p">:</span> <span class="s2">"MA"</span><span class="p">,</span> <span class="nt">"_id"</span> <span class="p">:</span> <span class="s2">"01008"</span> <span class="p">}</span>
</pre></div><p>And the output looks like this:</p>
<div class="highlight"><pre><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;cities</span> <span class="na">count=</span><span class="s">"5"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01001"</span> <span class="na">name=</span><span class="s">"AGAWAM"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.622739,42.070206"</span> <span class="na">population=</span><span class="s">"15338"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01002"</span> <span class="na">name=</span><span class="s">"CUSHMAN"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.51565,42.377017"</span> <span class="na">population=</span><span class="s">"36963"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01005"</span> <span class="na">name=</span><span class="s">"BARRE"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.108354,42.409698"</span> <span class="na">population=</span><span class="s">"4546"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01007"</span> <span class="na">name=</span><span class="s">"BELCHERTOWN"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.410953,42.275103"</span> <span class="na">population=</span><span class="s">"10579"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01008"</span> <span class="na">name=</span><span class="s">"BLANDFORD"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.936114,42.182949"</span> <span class="na">population=</span><span class="s">"1240"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cities&gt;</span>
</pre></div><p>We will only be using the Ruby 2.3.0 standard library, and the <a href="https://github.com/ohler55/ox">Ox gem</a> for writing the XML.</p><p>Let's get started!</p><h2>Designing The API</h2><p>After gathering the requirements, the next step is to ask: how much of this can be implemented with pure functions?</p><p>As it turns out, pretty much the entire thing could be a pure function. Reading the input is non-pure, and writing the output is also non-pure, but the entire conversion from JSON to XML <em>is</em> pure. The same input JSON always produces the same output XML.</p><p>The API for this converter could be used like this:</p>
<div class="highlight"><pre><span class="n">input</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">'input.json'</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="no">JSON2XML</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
<span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'output.xml'</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</pre></div><p>This example code could easily be written as a test. Just use some dummy input, and assert that <code>output</code> is correct.</p><p>Because the <code>File.read</code> and <code>File.write</code> calls are non-pure, I have purposely kept them separate from the conversion code. That allows the conversion step to be implemented as a pure function -- it just takes a string and returns a string.</p><p>This API looks pretty good to me, assuming that the input data isn't too big. If the input data set was huge, we wouldn't be able to load the whole thing into memory, so we would need so write some sort of streaming API. But, for the sake of demonstration, let's assume that we've investigated this possibility and decided that it's very unlikely that the input will ever be more than a few megabytes.</p>
<div class="alert alert-info">
  This is an example of the
  <a href="http://mollyrocket.com/casey/stream_0029.html">"write the usage code first" school of API design</a>,
  as advocated by Casey Muratori.
  For more API design advice from Casey, I recommend watching his talk:
  <a href="http://mollyrocket.com/casey/stream_0028.html">Designing and Evaluating Reusable Components</a>.
</div><h2>The Motivation</h2><p>The public API consists of a single method, which will be the pure function. Let's start with that:</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'ox'</span>

<span class="k">module</span> <span class="nn">JSON2XML</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
    <span class="c1"># TODO: implementation goes here</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div><p>We could easily implement all the functionality by writing a bunch of pure methods on the <code>JSON2XML</code> module, without defining any new classes. It would work, but I personally don't think that this is how Ruby is designed to be used. It's not what most people would consider to be idiomatic Ruby. We would be fighting the language – going against the grain. That's not fun.</p><p>To use Ruby the way it is designed to be used, we will need to define a class here. However, the class is unnecessary. It's an implementation detail. The public API is just a single pure function, so nobody should ever need to instantiate an object of the class we're about to create.</p><p>This is the motivation behind the pattern: we want the public API to be a simple pure function, but we want to implement that function with a private class.</p><h2>The Pattern</h2><p>Without further ado, here is the pattern:</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'ox'</span>

<span class="k">class</span> <span class="nc">JSON2XML</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
    <span class="kp">new</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:xml</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="nb">private_class_method</span> <span class="ss">:new</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
      <span class="vi">@input_json</span> <span class="o">=</span> <span class="n">input_json</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">xml</span>
      <span class="c1"># TODO: implementation goes here</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div><p>Instead of a module, <code>JSON2XML</code> is now a class. However, <code>private_class_method :new</code> prevents people from instantiating the class. Everything below the <code>convert</code> method is marked as private, signalling to other developers that <code>convert</code> is the only thing they should be calling, and everything else is an implementation detail.</p><p>The <code>convert</code> class method:</p>
<ol>
  <li>creates an object of its own class,</li>
  <li>passing its argument into the initializer,</li>
  <li>and calls a single method on the object, to generate the return value</li>
</ol><p>That's the overview of how the pattern works.</p><h2>Implementation Advantages</h2><p>Now let's finish off the implementation of the JSON to XML converter, to demonstrate some advantages of using this pattern.</p><p>The <code>xml</code> method is empty at the moment. It's supposed to return the output XML as a string, as required by the <code>convert</code> class method. How do you generate XML? One approach is to take some sort of XML "document" object, and serialize it. Let's do that:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">xml</span>
  <span class="no">Ox</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">with_xml</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div><p>"But wait!" I hear you say. "There is no <code>document</code> object. It doesn't exist." Let's create it, then.</p><p>How do you make a document object? Since we're using the Ox gem, we need to instantiate an <code>Ox::Document</code> and fill it with all the output. XML documents are only supposed to have a single root node in them, so all the content will have to be inside that.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">document</span>
  <span class="ss">Ox</span><span class="p">:</span><span class="ss">:Document</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">version</span><span class="p">:</span> <span class="s1">'1.0'</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
    <span class="n">doc</span> <span class="o">&lt;&lt;</span> <span class="n">root_node</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div><p>"But wait!" I hear you say, again. "Where did this <code>root_node</code> come from? That's not defined anywhere." Let's create it, then.</p><p>How do you make the root node? In Ox, you instantiate a <code>Ox::Element</code> object. We have to fill the root node with all the output data, so each city will have its own node inside the root node. Also, the root node has a "count" attribute on it, for reasons that I will explain later.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">root_node</span>
  <span class="ss">Ox</span><span class="p">:</span><span class="ss">:Element</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'cities'</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">root</span><span class="o">|</span>
    <span class="n">root</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span> <span class="o">=</span> <span class="n">city_nodes</span><span class="o">.</span><span class="n">size</span>
    <span class="n">city_nodes</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span> <span class="n">root</span> <span class="o">&lt;&lt;</span> <span class="n">city</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div><p>"But wait!" I hear you say, for a third time. "<code>city_nodes</code> doesn't exist either!" Let's create it. I'm sure you're getting the gist of what's happening here.</p><p>Each city node is also an <code>Ox::Element</code> object. We can create a city node from each line of the JSON input.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">city_nodes</span>
  <span class="n">input_json</span><span class="o">.</span><span class="n">each_line</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div><p>The <code>input_json</code> method is missing. That is the string value that was passed into the initializer. We can implement that with a simple <code>attr_reader :input_json</code>.</p><p>The <code>parse_city_node</code> method needs to be implemented, too. Here it is:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
  <span class="ss">Ox</span><span class="p">:</span><span class="ss">:Element</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'city'</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">city</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'_id'</span><span class="p">)</span>
    <span class="n">city</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'city'</span><span class="p">)</span>
    <span class="n">city</span><span class="o">[</span><span class="ss">:state</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'state'</span><span class="p">)</span>
    <span class="n">city</span><span class="o">[</span><span class="ss">:location</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'loc'</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
    <span class="n">city</span><span class="o">[</span><span class="ss">:population</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'pop'</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div><p>"But wait!" I don't hear you say, because the implementation is now complete. Here is the whole class:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">JSON2XML</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
    <span class="kp">new</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:xml</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="nb">private_class_method</span> <span class="ss">:new</span>
    <span class="kp">attr_reader</span> <span class="ss">:input_json</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
      <span class="vi">@input_json</span> <span class="o">=</span> <span class="n">input_json</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">xml</span>
      <span class="no">Ox</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">with_xml</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">document</span>
      <span class="ss">Ox</span><span class="p">:</span><span class="ss">:Document</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">version</span><span class="p">:</span> <span class="s1">'1.0'</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
        <span class="n">doc</span> <span class="o">&lt;&lt;</span> <span class="n">root_node</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">root_node</span>
      <span class="ss">Ox</span><span class="p">:</span><span class="ss">:Element</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'cities'</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">root</span><span class="o">|</span>
        <span class="n">root</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span> <span class="o">=</span> <span class="n">city_nodes</span><span class="o">.</span><span class="n">size</span>
        <span class="n">city_nodes</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span> <span class="n">root</span> <span class="o">&lt;&lt;</span> <span class="n">city</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">city_nodes</span>
      <span class="n">input_json</span><span class="o">.</span><span class="n">each_line</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="ss">Ox</span><span class="p">:</span><span class="ss">:Element</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'city'</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">city</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'_id'</span><span class="p">)</span>
        <span class="n">city</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'city'</span><span class="p">)</span>
        <span class="n">city</span><span class="o">[</span><span class="ss">:state</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'state'</span><span class="p">)</span>
        <span class="n">city</span><span class="o">[</span><span class="ss">:location</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'loc'</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
        <span class="n">city</span><span class="o">[</span><span class="ss">:population</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'pop'</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div><p>What I've just demonstrated is a top-down decomposition of the entire implementation. You start with the desired output – in this case, an XML string – and work backwards. You write the code that you wish existed, and implement it later. This is a nice way to break down complicated algorithms into smaller, and smaller pieces.</p><p>This is all made possible by Ruby's syntax. Ruby blurs the line between local variables and a method calls. This allows us to write identifiers representing values that we wish we had, as if they already exist as local variables, and then implement them later as methods. We're working with grain of the language, and this is one of the benefits.</p><p>Notice how none of the methods have side effects. Each method in the class is itself a pure function. The <code>@input_json</code> instance variable is never changed – it's essentially a constant. Because of that, we would expect that every method would always have the same return value. For example, if I call the <code>xml</code> method three times, I would get three identical strings. To use FP terminology, all of the methods have <em>referential transparency</em>.</p><h2>Performance Optimisation</h2><p>Astute readers may have noticed a performance hiccup in the <code>root_node</code> method.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">root_node</span>
  <span class="ss">Ox</span><span class="p">:</span><span class="ss">:Element</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'cities'</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">root</span><span class="o">|</span>
    <span class="n">root</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span> <span class="o">=</span> <span class="n">city_nodes</span><span class="o">.</span><span class="n">size</span>
    <span class="n">city_nodes</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span> <span class="n">root</span> <span class="o">&lt;&lt;</span> <span class="n">city</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div><p>I put the "count" attribute on the root node to demonstrate a common performance problem with this pattern.</p><p>The problem is that <code>city_nodes</code> is called two times. That means we're parsing the entire data set twice. That is unnecessary, and roughly doubles the run time of the conversion.</p><p>Thankfully, due to all the methods being pure, we have a simple solution to this problem: memoization. Memoization is the caching of return values from pure functions.</p><p>We've already seen that the <code>city_nodes</code> method always returns the same value. That means we can cache the return value the first time the function is called. On all subsequent calls, we can just return the cached value without running the rest of the function.</p><p>Cache invalidation can be a tricky problem, but not in this case. When do we need to invalidate the cache? Never! It's a pure function. The return value literally never changes. We can just forget about cache invalidation completely.</p><p>Here is the solution:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">city_nodes</span>
  <span class="vi">@city_nodes</span> <span class="o">||=</span>
    <span class="n">input_json</span><span class="o">.</span><span class="n">each_line</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div><p>The function implementation is exactly the same, except for the <code>@city_nodes ||=</code> line that has been added. This trick isn't specific to the PFAAO pattern, it's just normal, idiomatic Ruby.</p><p>Now we can call <code>city_nodes</code> as many times as we like, from any other method, without having to worry about performance. This is a cleaner solution than storing the return value in a local variable before using it.</p><h2>When To Use PFAAO</h2><p>This pattern is good for implementing complicated pure functions. I've written a DOCX to HTML converter this way, quite happily.</p><p>If the implementation is simple, it's not really worth defining a new class – just write a slightly larger function. If you're writing a pure function and it's growing out of control, that is the time to consider using this pattern.</p><p>Where the implementation is mostly pure, but not completely, you can still use this pattern. The implementation will be more complicated, but still have a small and simple public API. Ruby isn't Haskell. We can use side effects, in a controlled fashion, wherever it makes sense.</p><p>If your implementation requires a lot of mutable state, PFAAO is probably a bad fit.</p><h2>Conclusion</h2><p>It is possible, and even preferable, to write Ruby in a functional style. No monads or category theory required. Complicated pure functions can be written in idiomatic Ruby.</p><p>Again, you can get the code for the article from GitHub: <a href="https://github.com/tomdalling/pure-function-as-an-object">https://github.com/tomdalling/pure-function-as-an-object</a></p><p>We've also learnt that PFAAO is a cool acronym. Say it out loud. PFAAO. PFAAO.</p><p>PFAAO...</p></div>

  <footer>
    <div class="alert alert-info subscribe-bait">
      <p><strong>Enjoy this post?</strong></p>
      <a class="btn btn-success" href="/feed/">
        Subscribe via RSS
      </a>
      <a data-size="large" data-show-count="false" class="twitter-follow-button" href="https://twitter.com/tom_dalling">Follow @tom_dalling</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>

<div class="row programming-for-beginners-book">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-body">
        <div class="col-md-6">
          <a href="http://www.programmingforbeginnersbook.com/">
            <img class="img-responsive" src="/images/programming-for-beginners-cover.png" />
          </a>
        </div>
        <div class="col-md-6">
          <span class="h1">
            Programming for Beginners
            <small>Learn to Code by Making Little Games</small>
          </span>
          <p>Take your first step into the world of computer programming. This
          book assumes that you don't know anything about writing code, and
          teaches you the fundamental concepts that programmers use every day.
          You will need some basic computer skills – like downloading, opening,
          and saving files – but everything else will be explained here, step
          by step, starting from the very beginning.</p>
          <a class="btn btn-lg btn-primary" href="http://www.programmingforbeginnersbook.com/">
            Visit Book Website
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script id="disqus_script" type="text/javascript">
      var disqus_shortname = "tomdalling";
      var disqus_identifier = "com.tomdalling.blog.pure-function-as-an-object";
      var disqus_title = "The Pure Function As An Object (PFAAO) Ruby Pattern";
      var disqus_url = "http:\/\/www.tomdalling.com\/blog\/ruby\/pure-function-as-an-object-PFAAO-pattern\/";

      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript>
  </footer>

</article></main>

        <div class="col-md-4 sidebar">

          <div class="panel panel-default">
            <div class="panel-heading">Subscribe</div>
            <ul class="list-group">
              <li class="list-group-item">
                <a href="/blog/feed/">
                  <i class="fa fa-rss"></i> RSS
                </a>
              </li>
              <li class="list-group-item">
                <a href="https://twitter.com/tom_dalling">
                  <i class="fa fa-twitter"></i> Twitter
                </a>
              </li>
            </ul>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">Recent Posts</div>
            <ul class="list-group recent-posts">
              <li class="list-group-item">
                <a href="/blog/ruby/pure-function-as-an-object-PFAAO-pattern/">The Pure Function As An Object (PFAAO) Ruby Pattern</a>
              </li><li class="list-group-item">
                <a href="/blog/software-design/fizzbuzz-in-too-much-detail/">FizzBuzz In Too Much Detail</a>
              </li><li class="list-group-item">
                <a href="/blog/ruby/fruity-bat-flappy-bird-clone-in-ruby/">Making Fruity Bat (a Flappy Bird clone) in Ruby</a>
              </li><li class="list-group-item">
                <a href="/blog/modern-opengl/08-even-more-lighting-directional-lights-spotlights-multiple-lights/">Modern OpenGL 08 – Even More Lighting: Directional Lights, Spotlights, &amp; Multiple Lights</a>
              </li><li class="list-group-item">
                <a href="/blog/modern-opengl/opengl-in-2014/">OpenGL in 2014</a>
              </li>
            </ul>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">Blog Categories</div>
            <ul class="list-group categories">
              <li class="list-group-item">
                <a class="category" href="/blog/category/cocoa/">Cocoa</a>
                (<span class="post-count">5</span>
                <a href="/blog/category/cocoa/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/coding-styleconventions/">Coding Style/Conventions</a>
                (<span class="post-count">3</span>
                <a href="/blog/category/coding-styleconventions/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/coding-tips/">Coding Tips</a>
                (<span class="post-count">4</span>
                <a href="/blog/category/coding-tips/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/random-stuff/">Miscellaneous</a>
                (<span class="post-count">1</span>
                <a href="/blog/category/random-stuff/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/modern-opengl/">Modern OpenGL Series</a>
                (<span class="post-count">10</span>
                <a href="/blog/category/modern-opengl/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/ruby/">Ruby</a>
                (<span class="post-count">2</span>
                <a href="/blog/category/ruby/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/software-design/">Software Design</a>
                (<span class="post-count">9</span>
                <a href="/blog/category/software-design/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/software-processes/">Software Processes</a>
                (<span class="post-count">1</span>
                <a href="/blog/category/software-processes/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li><li class="list-group-item">
                <a class="category" href="/blog/category/web/">Web</a>
                (<span class="post-count">1</span>
                <a href="/blog/category/web/feed/" class="feed"><i class="fa fa-rss"></i></a>)
              </li>
            </ul>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">Blog Archives</div>
            <ul class="list-group archives">
              <li class="list-group-item">
                <a class="month" href="/blog/2016/02/">February 2016</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2015/04/">April 2015</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2015/02/">February 2015</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2014/11/">November 2014</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2014/09/">September 2014</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2014/02/">February 2014</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2013/04/">April 2013</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2013/03/">March 2013</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2013/02/">February 2013</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2013/01/">January 2013</a>
                (<span class="post-count">2</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2012/12/">December 2012</a>
                (<span class="post-count">2</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2012/11/">November 2012</a>
                (<span class="post-count">2</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2012/07/">July 2012</a>
                (<span class="post-count">2</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2012/05/">May 2012</a>
                (<span class="post-count">2</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2012/03/">March 2012</a>
                (<span class="post-count">2</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2011/12/">December 2011</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2010/12/">December 2010</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2010/11/">November 2010</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2010/05/">May 2010</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2010/04/">April 2010</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2010/02/">February 2010</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2009/12/">December 2009</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2009/11/">November 2009</a>
                (<span class="post-count">3</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2009/10/">October 2009</a>
                (<span class="post-count">2</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2009/07/">July 2009</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2009/06/">June 2009</a>
                (<span class="post-count">1</span>)
              </li><li class="list-group-item">
                <a class="month" href="/blog/2009/05/">May 2009</a>
                (<span class="post-count">1</span>)
              </li>
            </ul>
          </div>

        </div>
      </div>

      <footer class="page-footer">
        <p>© 2009 – <span class="current-year">2016</span> Tom Dalling</p>

        <p class="social">
          <a href="https://twitter.com/tom_dalling">
            <i class="fa fa-lg fa-twitter"></i>
          </a>
          <a href="https://github.com/tomdalling">
            <i class="fa fa-lg fa-github"></i>
          </a>
          <a href="https://stackoverflow.com/users/108105/tom-dalling">
            <i class="fa fa-lg fa-stack-overflow"></i>
          </a>
          <a href="mailto:tom at tomdalling com">
            <i class="fa fa-lg fa-envelope"></i>
          </a>
        </p>
      </footer>

      <script src="/bundles/all.js"></script>
      <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$$','$$']],
            displayMath: [['[blockmath]', '[/blockmath]']]
          }
        });
      </script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </div></body>

</html>